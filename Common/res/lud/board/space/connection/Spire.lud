(define "PlatformContainsLessThanTwo"
	(and {
		(< 
			(count Pieces in:
				(intersection 
						(union {(sites Direction from:(to) N distance:1) (sites Direction from:(to) W distance:1) (sites Direction from:(to) NW distance:1)})
						(sites Occupied by:Mover)
				)
			)
			2
		)
		(< 
			(count Pieces in:
				(intersection 
						(union {(sites Direction from:(to) N distance:1) (sites Direction from:(to) E distance:1) (sites Direction from:(to) NE distance:1)})
						(sites Occupied by:Mover)
				)
			)
			2
		)
		(< 
			(count Pieces in:
				(intersection 
						(union {(sites Direction from:(to) S distance:1) (sites Direction from:(to) W distance:1) (sites Direction from:(to) SW distance:1)})
						(sites Occupied by:Mover)
				)
			)
			2
		)
		(< 
			(count Pieces in:
				(intersection 
						(union {(sites Direction from:(to) S distance:1) (sites Direction from:(to) E distance:1) (sites Direction from:(to) SE distance:1)})
						(sites Occupied by:Mover)
				)
			)
			2
		)
	})
)


(define "PlatformContainsLessThanTwoNeutral"
	(and {
		(< 
			(count Pieces in:
				(intersection 
						(union {(sites Direction from:(to) N distance:1) (sites Direction from:(to) W distance:1) (sites Direction from:(to) NW distance:1)})
						(sites Occupied by:Neutral)
				)
			)
			2
		)
		(< 
			(count Pieces in:
				(intersection 
						(union {(sites Direction from:(to) N distance:1) (sites Direction from:(to) E distance:1) (sites Direction from:(to) NE distance:1)})
						(sites Occupied by:Neutral)
				)
			)
			2
		)
		(< 
			(count Pieces in:
				(intersection 
						(union {(sites Direction from:(to) S distance:1) (sites Direction from:(to) W distance:1) (sites Direction from:(to) SW distance:1)})
						(sites Occupied by:Neutral)
				)
			)
			2
		)
		(< 
			(count Pieces in:
				(intersection 
						(union {(sites Direction from:(to) S distance:1) (sites Direction from:(to) E distance:1) (sites Direction from:(to) SE distance:1)})
						(sites Occupied by:Neutral)
				)
			)
			2
		)
	})
)

//------------------------------------------------------------------------------

(game "Spire" 
	    (players 2) 
	    (equipment { 
	        (board (square 4 pyramidal:True) use:Vertex) 
	        (piece "Ball" Each)
	        (piece "Ball" Neutral)
	        (hand Each)
	        (hand Shared)
	    }) 
	    
	    (rules 
    		(start {
            	(place "Ball" "Hand" count:16)
            	(place "Ball0" 32 count:16)
            })
	    	(play 
	    		(or
		    		(if
		    			(not (is Prev Mover))
		    			(or
			    			(move 
			    				(from (handSite Mover)) 
			    	    		(to 
			    	    			(sites Empty) 
			    	    			if:(and {(is Flat) "PlatformContainsLessThanTwo" (< (count SitesPlatformBelow who:Mover) 2)})
			    	    		)
			    	    	)
			    			(move 
			    				(from (handSite Shared))
			    	    		(to 
			    	    			(sites Empty) 
			    	    			if:(and {(is Flat) "PlatformContainsLessThanTwoNeutral" (< (count SitesPlatformBelow who:Neutral) 2)})
			    	    		)
			    	    		(then (moveAgain))
			    	    	)
		    			)
		    		)
		    		(if
		    			(is Prev Mover)
		    			(move 
		    				(from (handSite Mover)) 
		    	    		(to 
		    	    			(sites Empty) 
		    	    			if:(and {(is Flat) "PlatformContainsLessThanTwo" (< (count SitesPlatformBelow who:Mover) 2)})
		    	    		)
		    	    	)
		    		)
	    		)
	    	)
	
	    	(end {
	    		(if (was Pass) 
	    			(result Next Win)
	    		)
	    		(if 
	    			(= (count Pieces in:(sites Occupied by:All)) 30)
	        		(result All Draw)
	            )
	    	})
	    	
	    )
	)

//------------------------------------------------------------------------------

(metadata 
		
		(info
				{
				}
			)
    
		(graphics {
	        (piece Scale "Ball" 1.0)
	        (board Style Shibumi)
	        (piece Colour Neutral fillColour:(colour Red))
	        (piece Colour P1 fillColour:(colour White))
	        (piece Colour P2 fillColour:(colour Black))
	    })
       
)